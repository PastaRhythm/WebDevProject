{% extends "main.html" %}

{% block body %}

<a href="{{ url_for('dashboard') }}">Back to Dashboard</a>
<br>

<div class="mx-6 p-1" id="terminal"></div>

<details class="ml-6">
    <summary>Terminal Notes</summary>
    <ul class="content">
        <li>Remember to run <code>apt-get update</code> to update package lists on a new site.</li>
        <li>Stateful commands, like <code>cd</code> and <code>nano</code>, are not yet supported.</li>
        <li>Don't forget to add a <code>-y</code> to your <code>apt install</code> commands.</li>
        <li>Remember that the terminal is in an experimental stage, so all functions are not supported.</li>
        <li>Make sure your github repo is set to public before cloning into the <code>/var/www/html/</code> directory to avoid an issue with a stateful command.</li>
    </ul>
</details>



<link rel="stylesheet" href="{{ url_for('static', filename='css/xterm.css') }}">
<script src="{{ url_for('static', filename='js/socketio.js') }}" ></script>
<script src="{{ url_for('static', filename='js/xterm.js') }}"></script>

<script>
    //create terminal
    var term = new Terminal();
    term.open(document.getElementById('terminal'));

    //add prompt function
    //add function to prompt user for input
    term.prompt = function(){
        term.write("\r\n$ ")
    }

    //greet the user
    //term.write('Hello from \x1B[1;3;31mxterm.js\x1B[0m $ ')
    term.write("Greetings from \x1B[1;3;32m{{ site.name_lbl | safe }}!\x1B[0m")
    term.prompt()

    //store terminal contents
    var entries = []
    var curr_line = ""
    var prev_cmd_idx = 1

    //respond to keys being pressed
    term.on('key', (key, event)=>{
        //index of prev command to get on up key pressed
        
        
        //enter key
        if (event.keyCode === 13){
            //save entries
            entries.push(curr_line)

            //send command to server
            send_command(curr_line)

            //clear out curr_line to prepare for next command
            curr_line = ""
            term.write("\r\n")
        }
        //backspace key
        else if (event.keyCode === 8){
            curr_line = curr_line.slice(0, curr_line.length-1)
            term.write("\b \b")
        }
        //up arrow key
        /*
        else if (event.keyCode === 38){
            const prev_entry = entries.length >= prev_cmd_idx ? entries[entries.length - prev_cmd_idx] : entries[0]
            prev_cmd_idx += 1
            term.write(prev_entry)
        }
        //down arrow key
        else if (event.keyCode === 40){}
        */
        //other keys
        else {
            curr_line += key
            term.write(key)
        }
    })


    //create window terminal object
    window.terminal = {}
    window.terminal.socket = io.connect("/");
    window.terminal.site_id = "{{ site.id }}"

    //do this when connection is successful
    window.terminal.socket.on("connect", join)

    //do this when output from a command is received
    window.terminal.socket.on('command', receive_results)

    //do this when auth failure is received
    window.terminal.socket.on("auth_failure", auth_failure)




    //socketio functions
    function join() {
        // log the successful connection and the socket's id
        console.log(`Connected: Socket ${window.terminal.socket.id}`);
    }

    //functions for sending and receiving terminal io
    function send_command(command){
        //send message
        window.terminal.socket.emit('command',{
            'site_id': window.terminal.site_id,
            'command': command,
        })
    }

    function receive_results(data){
        //if command failed
        if (data.stderr){
            term.write("\x1B[1;3;31m" + data.stderr +"\x1B[0m".replace(/(\r|\n)/g, "\r\n"))
        }
        //if command succeeded
        else if (data.stdout){
            term.write(data.stdout.replace(/(\r|\n)/g, "\r\n"))
        }

        //prompt for next input
        term.prompt()
    }

    function auth_failure(data){
        term.write("\x1B[1;3;31m" + data.stderr +"\x1B[0m".replace(/(\r|\n)/g, "\r\n"))
    }

</script>

{% endblock %}